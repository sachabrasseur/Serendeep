cd /home/claude && cat > serendeep_v2_script.js << 'EOF'
// SERENDEEP - Version 2.0
// Modifications : Type de projet, Renommage, Mode Tests refonte, Mode Explorer amélioration

let currentProject = '';
let projectType = ''; // Nouveau : type de projet
let clouds = {};
let clusters = {};
let conversations = {};

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
    loadProjects();
    setupEventListeners();
});

function setupEventListeners() {
    // Bouton créer nouveau projet
    document.getElementById('createProjectBtn')?.addEventListener('click', showProjectCreationModal);
    
    // Gestion nuages
    document.getElementById('addCloudBtn')?.addEventListener('click', addCloud);
    document.getElementById('cloudUpload')?.addEventListener('change', handleImageUpload);
    
    // Modes dialogue
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', (e) => switchMode(e.target.dataset.mode));
    });
    
    document.getElementById('sendMessageBtn')?.addEventListener('click', sendMessage);
    document.getElementById('userInput')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}

function showProjectCreationModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>Nouveau Projet</h2>
            <div class="form-group">
                <label>Nom du projet :</label>
                <input type="text" id="newProjectName" placeholder="Mon projet">
            </div>
            <div class="form-group">
                <label>Type de projet :</label>
                <div class="radio-group">
                    <label><input type="radio" name="projectType" value="série" checked> Série de fiction</label>
                    <label><input type="radio" name="projectType" value="film"> Long-métrage</label>
                    <label><input type="radio" name="projectType" value="podcast"> Podcast narratif</label>
                    <label><input type="radio" name="projectType" value="documentaire"> Documentaire</label>
                </div>
            </div>
            <div class="modal-actions">
                <button onclick="this.closest('.modal').remove()">Annuler</button>
                <button onclick="createProject()">Créer le projet</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('newProjectName').focus();
}

function createProject() {
    const nameInput = document.getElementById('newProjectName');
    const name = nameInput.value.trim();
    const selectedType = document.querySelector('input[name="projectType"]:checked').value;
    
    if (!name) {
        alert('Veuillez entrer un nom de projet');
        return;
    }
    
    currentProject = name;
    projectType = selectedType;
    clouds[currentProject] = [];
    clusters[currentProject] = [];
    conversations[currentProject] = [];
    
    saveProjects();
    document.querySelector('.modal')?.remove();
    updateProjectDisplay();
    showWorkspace();
}

function updateProjectDisplay() {
    const display = document.getElementById('currentProjectDisplay');
    if (display && currentProject) {
        display.innerHTML = `
            <span class="project-name" onclick="showRenameModal()">${currentProject}</span>
            <span class="project-type">${projectType}</span>
            <button class="rename-btn" onclick="showRenameModal()">✏️ Renommer</button>
        `;
    }
}

function showRenameModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>Renommer le projet</h2>
            <div class="form-group">
                <label>Nouveau nom :</label>
                <input type="text" id="renameProjectInput" value="${currentProject}">
            </div>
            <div class="modal-actions">
                <button onclick="this.closest('.modal').remove()">Annuler</button>
                <button onclick="renameProject()">Renommer</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('renameProjectInput').focus();
    document.getElementById('renameProjectInput').select();
}

function renameProject() {
    const newName = document.getElementById('renameProjectInput').value.trim();
    
    if (!newName || newName === currentProject) {
        document.querySelector('.modal')?.remove();
        return;
    }
    
    // Renommer dans toutes les structures de données
    clouds[newName] = clouds[currentProject];
    clusters[newName] = clusters[currentProject];
    conversations[newName] = conversations[currentProject];
    
    delete clouds[currentProject];
    delete clusters[currentProject];
    delete conversations[currentProject];
    
    currentProject = newName;
    saveProjects();
    updateProjectDisplay();
    document.querySelector('.modal')?.remove();
}

// Mode Explorer - Refonte pour ouverture des possibles
async function handleExplorerMode(userMessage) {
    const selectedClouds = getSelectedClouds();
    const cloudsContext = selectedClouds.map(c => c.content).join('\n\n');
    
    const prompt = `Tu es en mode EXPLORATION RHIZOMATIQUE.
Contexte du projet (${projectType}) : ${currentProject}

Nuages d'intuition :
${cloudsContext}

Message utilisateur : ${userMessage}

CONSIGNE : Ne cherche pas à analyser le "pourquoi". Ouvre le champ des possibles :
- Propose des tangentes inattendues
- Fais des connections surprenantes entre les éléments
- Suggère des ramifications narratives
- Imagine des angles non évidents
- Crée des ponts avec d'autres univers/références
- Libère les associations d'idées

Réponds de manière ouverte et générative, pas analytique.`;

    return await callClaude(prompt);
}

// Mode Tests - Nouveau workflow
let testResults = {};
let testCombination = [];

function initTestMode() {
    const testPanel = document.getElementById('testPanel');
    const selectedClouds = getSelectedClouds();
    
    if (selectedClouds.length === 0) {
        testPanel.innerHTML = '<p>Sélectionnez des nuages pour les tester</p>';
        return;
    }
    
    testResults = {};
    testCombination = [];
    
    testPanel.innerHTML = `
        <h3>Tests individuels</h3>
        <div class="test-grid">
            ${selectedClouds.map((cloud, i) => `
                <div class="test-card" data-index="${i}">
                    <h4>Nuage ${i + 1}: ${cloud.content.substring(0, 30)}...</h4>
                    <button onclick="testIndividualCloud(${i})">Tester</button>
                    <div class="test-result" id="result-${i}"></div>
                </div>
            `).join('')}
        </div>
        <div id="combinationPanel" style="display:none;">
            <h3>Combinaison</h3>
            <div id="combinationControls"></div>
            <div id="combinationResult"></div>
        </div>
    `;
}

async function testIndividualCloud(index) {
    const selectedClouds = getSelectedClouds();
    const cloud = selectedClouds[index];
    
    const resultDiv = document.getElementById(`result-${index}`);
    resultDiv.innerHTML = '<p>Test en cours...</p>';
    
    // Prompt adapté selon le type de projet
    let formatContext = '';
    if (projectType === 'série') {
        formatContext = 'Structure sérielle, arcs narratifs multiples, personnages récurrents.';
    } else if (projectType === 'film') {
        formatContext = 'Structure trois actes, condensation dramatique, film de 90-120 minutes.';
    } else if (projectType === 'podcast') {
        formatContext = 'Format audio narratif, importance du son, rythme et narration orale.';
    } else if (projectType === 'documentaire') {
        formatContext = 'Ancrage dans le réel, enquête, point de vue documentaire.';
    }
    
    const prompt = `Projet : ${currentProject} (${projectType})
Format : ${formatContext}

Teste ce nuage d'intuition isolément :
"${cloud.content}"

Propose UNE piste de développement pour ce nuage en tenant compte du format ${projectType}.
Sois concis et concret (max 150 mots).`;

    const result = await callClaude(prompt);
    testResults[index] = result;
    
    resultDiv.innerHTML = `
        <div class="test-result-content">${result}</div>
        <label>
            <input type="checkbox" onchange="toggleCombination(${index})">
            Combiner
        </label>
    `;
    
    updateCombinationPanel();
}

function toggleCombination(index) {
    const checkbox = event.target;
    if (checkbox.checked) {
        testCombination.push(index);
    } else {
        testCombination = testCombination.filter(i => i !== index);
    }
    updateCombinationPanel();
}

function updateCombinationPanel() {
    const panel = document.getElementById('combinationPanel');
    const controls = document.getElementById('combinationControls');
    
    if (testCombination.length >= 2) {
        panel.style.display = 'block';
        controls.innerHTML = `
            <p>Éléments sélectionnés : ${testCombination.map(i => `Nuage ${i+1}`).join(' + ')}</p>
            <button onclick="generateCombination()">Générer la combinaison</button>
        `;
    } else {
        panel.style.display = 'none';
    }
}

async function generateCombination() {
    const resultDiv = document.getElementById('combinationResult');
    resultDiv.innerHTML = '<p>Génération en cours...</p>';
    
    const combinedResults = testCombination.map(i => testResults[i]).join('\n\n---\n\n');
    
    let formatContext = '';
    if (projectType === 'série') {
        formatContext = 'série de fiction avec structure sérielle';
    } else if (projectType === 'film') {
        formatContext = 'long-métrage avec structure trois actes';
    } else if (projectType === 'podcast') {
        formatContext = 'podcast narratif avec attention au son';
    } else if (projectType === 'documentaire') {
        formatContext = 'documentaire ancré dans le réel';
    }
    
    const prompt = `Projet : ${currentProject} (${projectType})

Voici plusieurs pistes développées séparément :

${combinedResults}

CONSIGNE : Synthétise ces pistes en UNE proposition cohérente pour un projet de ${formatContext}.
Crée une synergie entre les éléments. Max 250 mots.`;

    const combination = await callClaude(prompt);
    
    resultDiv.innerHTML = `
        <div class="combination-editor">
            <textarea id="combinationText" rows="10">${combination}</textarea>
            <div class="combination-actions">
                <button onclick="regenerateCombination()">Régénérer la combinaison</button>
                <button onclick="improveCombination()">Améliorer ma version</button>
                <button onclick="validateCombination()">Valider et sauvegarder comme grappe</button>
            </div>
            <p class="warning">⚠️ Ajouter/retirer des éléments écrasera cette version (sauf si validée)</p>
        </div>
    `;
}

async function regenerateCombination() {
    // Reset le textarea et régénère
    await generateCombination();
}

async function improveCombination() {
    const textarea = document.getElementById('combinationText');
    const userVersion = textarea.value;
    
    textarea.value = 'Amélioration en cours...';
    
    const prompt = `Voici une combinaison narrative que l'utilisateur a modifiée :

"${userVersion}"

CONSIGNE : Améliore cette version en :
- Renforçant la cohérence
- Affinant la langue
- Précisant les éléments flous
- Gardant l'intention et le sens de l'utilisateur

Max 250 mots.`;

    const improved = await callClaude(prompt);
    textarea.value = improved;
}

function validateCombination() {
    const textarea = document.getElementById('combinationText');
    const content = textarea.value;
    
    if (!clusters[currentProject]) {
        clusters[currentProject] = [];
    }
    
    clusters[currentProject].push({
        date: new Date().toISOString(),
        clouds: testCombination.map(i => getSelectedClouds()[i]),
        content: content
    });
    
    saveProjects();
    alert('Grappe sauvegardée !');
    
    // Reset
    testCombination = [];
    initTestMode();
}

// Mode Stratégique - Adapté selon type de projet
async function handleStrategicMode(userMessage) {
    const selectedClouds = getSelectedClouds();
    const cloudsContext = selectedClouds.map(c => c.content).join('\n\n');
    
    let formatContext = '';
    if (projectType === 'série') {
        formatContext = 'Pense structure sérielle, arcs de saison, bible de personnages, potentiel de développement multi-saisons.';
    } else if (projectType === 'film') {
        formatContext = 'Pense structure trois actes, condensation narrative, arc unique et complet.';
    } else if (projectType === 'podcast') {
        formatContext = 'Pense format audio, épisodes, narration sonore, identité vocale.';
    } else if (projectType === 'documentaire') {
        formatContext = 'Pense enquête, angle éditorial, accès au réel, dispositif filmique.';
    }
    
    const prompt = `Tu es en mode STRATÉGIQUE pour un projet de ${projectType}.
${formatContext}

Projet : ${currentProject}

Nuages d'intuition :
${cloudsContext}

Message utilisateur : ${userMessage}

CONSIGNE : Réponds de manière stratégique et professionnelle en tenant compte des contraintes et opportunités du format ${projectType}.`;

    return await callClaude(prompt);
}

// Fix upload image - Envoi à Claude
async function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        const base64 = e.target.result.split(',')[1];
        
        // Stocker l'image dans le nuage actuel
        const cloudContent = document.getElementById('cloudInput').value;
        addCloud({ content: cloudContent, image: base64 });
        
        // Clear input
        document.getElementById('cloudInput').value = '';
        event.target.value = '';
    };
    reader.readAsDataURL(file);
}

async function sendMessage() {
    const input = document.getElementById('userInput');
    const message = input.value.trim();
    if (!message) return;
    
    input.value = '';
    addMessageToChat('user', message);
    
    const currentMode = document.querySelector('.mode-btn.active')?.dataset.mode || 'conversational';
    
    let response;
    switch(currentMode) {
        case 'explorer':
            response = await handleExplorerMode(message);
            break;
        case 'strategic':
            response = await handleStrategicMode(message);
            break;
        case 'psychoanalytic':
            response = await handlePsychoanalyticMode(message);
            break;
        default:
            response = await handleConversationalMode(message);
    }
    
    addMessageToChat('assistant', response);
    saveConversation(currentMode, message, response);
}

async function callClaude(prompt) {
    // Récupérer les images des nuages sélectionnés
    const selectedClouds = getSelectedClouds();
    const images = selectedClouds
        .filter(c => c.image)
        .map(c => ({
            type: "image",
            source: {
                type: "base64",
                media_type: "image/jpeg",
                data: c.image
            }
        }));
    
    const messages = [
        {
            role: "user",
            content: [
                ...images,
                { type: "text", text: prompt }
            ]
        }
    ];
    
    try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                model: "claude-sonnet-4-20250514",
                max_tokens: 1000,
                messages: messages
            })
        });
        
        const data = await response.json();
        return data.content.find(c => c.type === "text")?.text || "Erreur de réponse";
    } catch (error) {
        console.error("Erreur API:", error);
        return "Erreur de connexion à l'API";
    }
}

// Fonctions utilitaires
function getSelectedClouds() {
    if (!clouds[currentProject]) return [];
    return clouds[currentProject].filter(c => c.selected);
}

function addCloud(cloudData) {
    if (!clouds[currentProject]) {
        clouds[currentProject] = [];
    }
    
    clouds[currentProject].push({
        id: Date.now(),
        date: new Date().toISOString(),
        content: cloudData.content || cloudData,
        image: cloudData.image || null,
        selected: false
    });
    
    saveProjects();
    renderClouds();
}

function renderClouds() {
    const container = document.getElementById('cloudsContainer');
    if (!container || !clouds[currentProject]) return;
    
    container.innerHTML = clouds[currentProject].map((cloud, i) => `
        <div class="cloud ${cloud.selected ? 'selected' : ''}" onclick="toggleCloudSelection(${i})">
            ${cloud.image ? '<img src="data:image/jpeg;base64,' + cloud.image + '" alt="Image nuage">' : ''}
            <p>${cloud.content}</p>
        </div>
    `).join('');
}

function toggleCloudSelection(index) {
    clouds[currentProject][index].selected = !clouds[currentProject][index].selected;
    renderClouds();
}

function saveProjects() {
    localStorage.setItem('serendeep_clouds', JSON.stringify(clouds));
    localStorage.setItem('serendeep_clusters', JSON.stringify(clusters));
    localStorage.setItem('serendeep_conversations', JSON.stringify(conversations));
    localStorage.setItem('serendeep_currentProject', currentProject);
    localStorage.setItem('serendeep_projectType', projectType);
}

function loadProjects() {
    clouds = JSON.parse(localStorage.getItem('serendeep_clouds')) || {};
    clusters = JSON.parse(localStorage.getItem('serendeep_clusters')) || {};
    conversations = JSON.parse(localStorage.getItem('serendeep_conversations')) || {};
    currentProject = localStorage.getItem('serendeep_currentProject') || '';
    projectType = localStorage.getItem('serendeep_projectType') || '';
    
    if (currentProject) {
        updateProjectDisplay();
        showWorkspace();
    }
}

function addMessageToChat(role, content) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    messageDiv.textContent = content;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function saveConversation(mode, userMessage, assistantResponse) {
    if (!conversations[currentProject]) {
        conversations[currentProject] = [];
    }
    
    conversations[currentProject].push({
        mode,
        date: new Date().toISOString(),
        user: userMessage,
        assistant: assistantResponse
    });
    
    saveProjects();
}

function showWorkspace() {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('workspace').style.display = 'block';
    renderClouds();
}

function switchMode(mode) {
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (mode === 'tests') {
        initTestMode();
    }
}

// Modes non modifiés (Conversational et Psychoanalytic)
async function handleConversationalMode(userMessage) {
    const selectedClouds = getSelectedClouds();
    const cloudsContext = selectedClouds.map(c => c.content).join('\n\n');
    
    const prompt = `Projet : ${currentProject}

Nuages d'intuition :
${cloudsContext}

Message utilisateur : ${userMessage}

Réponds de manière conversationnelle et naturelle.`;

    return await callClaude(prompt);
}

async function handlePsychoanalyticMode(userMessage) {
    const selectedClouds = getSelectedClouds();
    const cloudsContext = selectedClouds.map(c => c.content).join('\n\n');
    
    const prompt = `Tu es en mode PSYCHANALYTIQUE.

Projet : ${currentProject}

Nuages d'intuition :
${cloudsContext}

Message utilisateur : ${userMessage}

CONSIGNE : Interroge les désirs latents, les contradictions, les non-dits. Creuse les tensions sous-jacentes.`;

    return await callClaude(prompt);
}
EOF
