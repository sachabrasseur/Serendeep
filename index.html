<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Serendeep</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Mono:wght@300;400&family=Crimson+Pro:wght@300;400;500;600&display=swap');

*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    --ink: #111009;
    --paper: #f6f3ee;
    --paper2: #edeae4;
    --paper3: #e2ddd6;
    --white: #fff;
    --accent: #bf3c18;
    --muted: #8c8880;
    --border: #cdc8c0;
    --green: #3a6b49;
    --orange: #c47a1a;
    --blue: #2a5a8a;
    --purple: #6b3a8a;
    --shadow: 0 1px 8px rgba(17,16,9,.07), 0 2px 20px rgba(17,16,9,.04);
    --shadow-lg: 0 4px 32px rgba(17,16,9,.12);
}

html, body {
    height: 100%;
    background: var(--paper);
    color: var(--ink);
    font-family: 'Crimson Pro', serif;
    font-size: 16px;
    line-height: 1.55;
}

body::after {
    content: '';
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9999;
    opacity: .4;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='.07'/%3E%3C/svg%3E");
}

#app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
}

/* HEADER */
#hdr {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 11px 24px;
    border-bottom: 1px solid var(--border);
    background: rgba(246,243,238,.94);
    backdrop-filter: blur(10px);
    flex-shrink: 0;
    z-index: 50;
}

.hdr-l {
    display: flex;
    align-items: baseline;
    gap: 14px;
}

.logo {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 600;
}

.logo em {
    color: var(--accent);
    font-style: italic;
}

#proj-lbl {
    font-family: 'IBM Plex Mono', monospace;
    font-size: .67rem;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 1px dashed var(--border);
    padding-bottom: 1px;
    transition: color .15s;
    max-width: 220px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

#proj-lbl:hover {
    color: var(--ink);
}

.proj-type-badge {
    font-family: 'IBM Plex Mono', monospace;
    font-size: .62rem;
    background: var(--blue);
    color: var(--white);
    padding: 2px 8px;
    border-radius: 20px;
    margin-left: 8px;
}

#ctr {
    font-family: 'IBM Plex Mono', monospace;
    font-size: .62rem;
    background: var(--paper3);
    padding: 2px 8px;
    border-radius: 20px;
    color: var(--muted);
}

.hdr-r {
    display: flex;
    gap: 7px;
    align-items: center;
}

/* BUTTONS */
.btn {
    font-family: 'Crimson Pro', serif;
    font-size: .85rem;
    padding: 5px 13px;
    border-radius: 3px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--ink);
    cursor: pointer;
    transition: all .15s;
}

.btn:hover {
    background: var(--paper2);
    border-color: var(--muted);
}

.btn-ink {
    background: var(--ink);
    color: var(--paper);
    border-color: var(--ink);
}

.btn-ink:hover {
    background: #2c2a26;
}

.btn-sm {
    font-size: .77rem;
    padding: 4px 10px;
}

.btn-danger {
    color: var(--accent);
}

.btn-danger:hover {
    background: #fdf0ec;
    border-color: #e8a898;
}

.btn-green {
    color: var(--green);
    border-color: var(--green);
}

.btn-green:hover {
    background: #eef6f1;
}

.btn-ghost {
    border-color: transparent;
}

.btn-ghost:hover {
    background: var(--paper2);
    border-color: var(--border);
}

/* TABS */
#tabs {
    display: flex;
    padding: 0 24px;
    border-bottom: 1px solid var(--border);
    background: var(--paper);
    flex-shrink: 0;
}

.tab {
    font-family: 'IBM Plex Mono', monospace;
    font-size: .68rem;
    letter-spacing: .1em;
    text-transform: uppercase;
    padding: 10px 16px;
    border: none;
    background: none;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all .15s;
}

.tab:hover {
    color: var(--ink);
}

.tab.on {
    color: var(--ink);
    border-bottom-color: var(--accent);
}

/* MAIN */
#main {
    flex: 1;
    overflow: hidden;
    display: flex;
    position: relative;
}

.sec {
    display: none;
    flex: 1;
    overflow-y: auto;
    padding: 22px 24px;
    flex-direction: column;
}

.sec.on {
    display: flex;
}

/* TOOLBAR */
.toolbar {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 16px;
}

.fbtn {
    font-family: 'IBM Plex Mono', monospace;
    font-size: .63rem;
    letter-spacing: .07em;
    text-transform: uppercase;
    padding: 4px 11px;
    border-radius: 2px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    transition: all .15s;
}

.fbtn:hover, .fbtn.on {
    background: var(--ink);
    color: var(--paper);
    border-color: var(--ink);
}

.tsep {
    width: 1px;
    height: 20px;
    background: var(--border);
    margin: 0 2px;
}

.srch-w {
    position: relative;
    display: flex;
    align-items: center;
}

#srch {
    font-family: 'Crimson Pro', serif;
    font-size: .87rem;
    padding: 5px 10px 5px 28px;
    border: 1px solid var(--border);
    border-radius: 3px;
    background: var(--white);
    color: var(--ink);
    outline: none;
    width: 190px;
    transition: border-color .15s;
}

#srch:focus {
    border-color: var(--muted);
}

#srch::placeholder {
    color: var(--muted);
    font-style: italic;
}

/* CLOUD GRID */
#cgrid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(225px, 1fr));
    gap: 11px;
    align-content: start;
}

.ccard {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 12px;
    cursor: pointer;
    transition: all .17s;
    position: relative;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    min-height: 105px;
    user-select: none;
}

.ccard:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-1px);
}

.ccard.sel {
    border: 2px solid var(--green);
    box-shadow: 0 0 0 3px rgba(58,107,73,.13), var(--shadow);
}

.chk {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 16px;
    height: 16px;
    border: 1.5px solid var(--border);
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    background: var(--white);
    transition: all .13s;
    pointer-events: none;
}

.ccard.sel .chk {
    background: var(--green);
    border-color: var(--green);
    color: var(--paper);
}

.cimg-w {
    position: relative;
    margin-bottom: 7px;
}

.cimg-w img {
    width: 100%;
    height: 76px;
    object-fit: cover;
    border-radius: 2px;
    display: block;
}

.ctxt {
    font-size: .85rem;
    line-height: 1.5;
    flex: 1;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 5;
    -webkit-box-orient: vertical;
}

/* MODAL */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(17,16,9,.5);
    backdrop-filter: blur(4px);
    z-index: 400;
    display: none;
    align-items: center;
    justify-content: center;
}

.modal.on {
    display: flex;
}

.modal-inner {
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 5px;
    width: 480px;
    max-width: 96vw;
    max-height: 82vh;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-lg);
    padding: 20px;
}

.modal-inner h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    margin-bottom: 16px;
}

.form-group {
    margin-bottom: 14px;
}

.form-group label {
    display: block;
    font-family: 'IBM Plex Mono', monospace;
    font-size: .7rem;
    text-transform: uppercase;
    letter-spacing: .08em;
    color: var(--muted);
    margin-bottom: 6px;
}

.form-group input[type="text"] {
    width: 100%;
    font-family: 'Crimson Pro', serif;
    font-size: .92rem;
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 3px;
    background: var(--white);
    color: var(--ink);
    outline: none;
}

.form-group input[type="text"]:focus {
    border-color: var(--muted);
}

.radio-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.radio-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Crimson Pro', serif;
    font-size: .88rem;
    text-transform: none;
    letter-spacing: normal;
    cursor: pointer;
    color: var(--ink);
}

.radio-group input[type="radio"] {
    cursor: pointer;
}

.modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 16px;
}

/* PANELS */
.panel {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow);
    overflow: hidden;
}

.ptitle {
    font-family: 'IBM Plex Mono', monospace;
    font-size: .63rem;
    letter-spacing: .1em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 12px;
    padding-bottom: 9px;
    border-bottom: 1px solid var(--paper3);
}

/* DIALOGUE PANEL */
#dlg-panel {
    position: fixed;
    right: 0;
    top: 93px;
    bottom: 0;
    width: 420px;
    background: var(--white);
    border-left: 1px solid var(--border);
    box-shadow: -4px 0 24px rgba(17,16,9,.08);
    display: none;
    flex-direction: column;
    z-index: 100;
}

#dlg-panel.on {
    display: flex;
}

#dlg-hdr {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

#dlg-hdr h3 {
    font-family: 'IBM Plex Mono', monospace;
    font-size: .68rem;
    letter-spacing: .1em;
    text-transform: uppercase;
    color: var(--muted);
}

.mode-tabs {
    display: flex;
    gap: 6px;
    padding: 12px 18px;
    border-bottom: 1px solid var(--paper3);
}

.mode-tab {
    font-family: 'IBM Plex Mono', monospace;
    font-size: .62rem;
    letter-spacing: .06em;
    text-transform: uppercase;
    padding: 5px 10px;
    border-radius: 2px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    transition: all .15s;
}

.mode-tab:hover {
    background: var(--paper2);
}

.mode-tab.on {
    background: var(--purple);
    color: var(--white);
    border-color: var(--purple);
}

#dlg-msgs {
    flex: 1;
    overflow-y: auto;
    padding: 14px 18px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.msg {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.mlbl {
    font-family: 'IBM Plex Mono', monospace;
    font-size: .6rem;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: var(--muted);
}

.mb {
    font-size: .85rem;
    line-height: 1.6;
    padding: 9px 11px;
    border-radius: 4px;
    white-space: pre-wrap;
}

.msg.mu .mb {
    background: var(--blue);
    color: var(--white);
}

.msg.mc .mb {
    background: var(--paper2);
    color: var(--ink);
}

#dlg-input {
    padding: 14px 18px;
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 8px;
}

#dlg-input textarea {
    font-family: 'Crimson Pro', serif;
    font-size: .85rem;
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 3px;
    background: var(--paper);
    color: var(--ink);
    outline: none;
    resize: vertical;
    min-height: 70px;
    line-height: 1.5;
}

#dlg-input textarea:focus {
    border-color: var(--muted);
}

/* TESTS SECTION */
#sec-tests {
    gap: 14px;
}

.tgrid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    flex: 1;
    min-height: 0;
}

.chips {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 10px;
    min-height: 30px;
}

.chip {
    font-family: 'Crimson Pro', serif;
    font-size: .8rem;
    padding: 3px 9px;
    background: var(--paper2);
    border: 1px solid var(--border);
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.chip-x {
    cursor: pointer;
    color: var(--muted);
    line-height: 1;
    font-size: .88rem;
    transition: color .12s;
}

.chip-x:hover {
    color: var(--accent);
}

.mode-bar {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
}

.combo-result {
    flex: 1;
    overflow-y: auto;
    font-size: .88rem;
    line-height: 1.68;
    white-space: pre-wrap;
    padding: 10px;
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 3px;
}

.combo-name-input {
    font-family: 'Crimson Pro', serif;
    font-size: .85rem;
    font-style: italic;
    padding: 7px 9px;
    border: 1px solid var(--border);
    border-radius: 3px;
    background: var(--white);
    color: var(--ink);
    outline: none;
    width: 100%;
}

.combo-name-input::placeholder {
    color: var(--muted);
}

.saved-combo-item {
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all .15s;
}

.saved-combo-item:hover {
    box-shadow: var(--shadow);
}

.saved-combo-name {
    font-weight: 600;
    margin-bottom: 4px;
}

.saved-combo-info {
    font-size: .75rem;
    color: var(--muted);
}

.cloud-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    overflow-y: auto;
    flex: 1;
}

.cloud-item {
    font-size: .82rem;
    padding: 6px 9px;
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 3px;
    cursor: pointer;
    transition: all .13s;
    display: flex;
    align-items: center;
    gap: 7px;
}

.cloud-item:hover {
    background: var(--paper2);
}

.cloud-item.sel {
    background: #eef6f1;
    border-color: var(--green);
}

.cloud-item input[type="checkbox"] {
    cursor: pointer;
}

/* PROJETS SECTION */
#sec-projets {
    gap: 16px;
}

.proj-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 14px;
}

.proj-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px;
    box-shadow: var(--shadow);
    transition: all .17s;
}

.proj-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-1px);
}

.proj-card.active {
    border: 2px solid var(--green);
}

.proj-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.05rem;
    font-style: italic;
    margin-bottom: 8px;
}

.proj-meta {
    font-size: .75rem;
    color: var(--muted);
    margin-bottom: 12px;
}

.proj-actions {
    display: flex;
    gap: 6px;
}

/* NOTIF */
#notif {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(14px);
    background: var(--ink);
    color: var(--paper);
    padding: 8px 16px;
    border-radius: 3px;
    font-size: .82rem;
    opacity: 0;
    transition: all .22s;
    z-index: 9998;
    pointer-events: none;
    white-space: nowrap;
}

#notif.on {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

/* LOADING */
.loading {
    display: inline-flex;
    gap: 4px;
    align-items: center;
}

.loading span {
    width: 5px;
    height: 5px;
    background: var(--muted);
    border-radius: 50%;
    animation: db 1.2s infinite;
}

.loading span:nth-child(2) {
    animation-delay: .2s;
}

.loading span:nth-child(3) {
    animation-delay: .4s;
}

@keyframes db {
    0%, 80%, 100% {
        transform: translateY(0);
        opacity: .4;
    }
    40% {
        transform: translateY(-5px);
        opacity: 1;
    }
}

::-webkit-scrollbar {
    width: 4px;
    height: 4px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 2px;
}

.empty {
    grid-column: 1/-1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 9px;
    padding: 46px 20px;
    color: var(--muted);
    text-align: center;
    font-style: italic;
}
</style>
</head>
<body>

<div id="app">
    <!-- HEADER -->
    <div id="hdr">
        <div class="hdr-l">
            <div class="logo">Seren<em>deep</em></div>
            <span id="proj-lbl" onclick="goToProjects()">‚Äî</span>
            <span id="ctr">0 nuages</span>
        </div>
        <div class="hdr-r">
            <button class="btn btn-ghost btn-sm" onclick="toggleDialogue()">üí¨ Dialogue</button>
            <button class="btn btn-ghost btn-sm" onclick="showSettings()">‚öô</button>
        </div>
    </div>

    <!-- TABS -->
    <div id="tabs">
        <button class="tab on" data-sec="nuages" onclick="switchTab('nuages')">NUAGES</button>
        <button class="tab" data-sec="tests" onclick="switchTab('tests')">TESTS</button>
        <button class="tab" data-sec="teaser" onclick="switchTab('teaser')">TEASER</button>
        <button class="tab" data-sec="projets" onclick="switchTab('projets')">PROJETS</button>
    </div>

    <!-- MAIN -->
    <div id="main">
        <!-- SECTION NUAGES -->
        <div id="sec-nuages" class="sec on">
            <div class="toolbar">
                <button class="fbtn on" data-filter="all" onclick="filterClouds('all')">TOUS</button>
                <button class="fbtn" data-filter="important" onclick="filterClouds('important')">IMPORTANTS</button>
                <button class="fbtn" data-filter="explored" onclick="filterClouds('explored')">EXPLOR√âS</button>
                <button class="fbtn" data-filter="unused" onclick="filterClouds('unused')">NON UTILIS√âS</button>
                <button class="fbtn" data-filter="images" onclick="filterClouds('images')">AVEC IMAGES</button>
                <div class="tsep"></div>
                <div class="srch-w">
                    <input type="text" id="srch" placeholder="Rechercher..." oninput="searchClouds()">
                </div>
                <button class="btn btn-ink btn-sm" style="margin-left:auto" onclick="showNewCloudModal()">+ Nouveau nuage</button>
            </div>
            <div id="cgrid"></div>
        </div>

        <!-- SECTION TESTS -->
        <div id="sec-tests" class="sec">
            <div class="tgrid">
                <div class="panel">
                    <div class="ptitle">
                        COMBINAISON ACTIVE
                        <button class="btn btn-green btn-sm" onclick="saveCombination()">‚úì Sauvegarder</button>
                    </div>
                    <div class="chips" id="active-chips"></div>
                    <div class="mode-bar">
                        <button class="fbtn on" data-mode="developper" onclick="switchComboMode('developper')">D√âVELOPPER</button>
                        <button class="fbtn" data-mode="explorer" onclick="switchComboMode('explorer')">EXPLORER</button>
                        <button class="fbtn" data-mode="resister" onclick="switchComboMode('resister')">R√âSISTER</button>
                    </div>
                    <button class="btn btn-sm" style="margin-bottom:10px" onclick="generateComboAnalysis()">Qu'est-ce que √ßa raconte ?</button>
                    <div class="combo-result" id="combo-result">S√©lectionnez des nuages pour commencer...</div>
                    <input type="text" class="combo-name-input" id="combo-name" placeholder="Nom de la combinaison..." style="margin-top:10px">
                </div>

                <div class="panel">
                    <div class="ptitle">COMBINAISONS SAUVEGARD√âES</div>
                    <div style="flex:1;overflow-y:auto" id="saved-combos"></div>
                </div>
            </div>

            <div class="panel" style="margin-top:14px">
                <div class="ptitle">NUAGES ‚Äî CLIC POUR AJOUTER</div>
                <div class="cloud-list" id="test-cloud-list"></div>
            </div>
        </div>

        <!-- SECTION TEASER -->
        <div id="sec-teaser" class="sec">
            <div class="tgrid">
                <div class="panel">
                    <div class="ptitle">TEASER NARRATIF</div>
                    <textarea id="teaser-text" style="flex:1;font-family:'Crimson Pro',serif;font-size:.88rem;line-height:1.68;padding:12px;border:1px solid var(--border);border-radius:3px;background:var(--paper);resize:none"></textarea>
                    <div style="display:flex;gap:8px;margin-top:10px">
                        <button class="btn btn-sm" onclick="generateTeaser()">üí° Je propose un teaser</button>
                        <button class="btn btn-sm" onclick="clearTeaser()">Effacer</button>
                        <button class="btn btn-green btn-sm" style="margin-left:auto" onclick="validateTeaser()">‚úì Valider ‚Äî Phase 2</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="ptitle">DEPUIS UNE COMBINAISON</div>
                    <select id="teaser-combo-select" style="width:100%;font-family:'Crimson Pro',serif;font-size:.85rem;padding:7px;border:1px solid var(--border);border-radius:3px;background:var(--white)">
                        <option value="">S√©lectionner une combinaison...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- SECTION PROJETS -->
        <div id="sec-projets" class="sec">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <div>
                    <h2 style="font-family:'Playfair Display',serif;font-size:1.3rem;font-style:italic;margin-bottom:4px">Mes projets</h2>
                    <p style="font-size:.85rem;color:var(--muted)">Chaque projet est isol√© ‚Äî nuages, combinaisons, journal.</p>
                </div>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-ink" onclick="showNewProjectModal()">+ Nouveau projet</button>
                    <button class="btn btn-sm">‚Üì Exporter</button>
                    <button class="btn btn-sm">‚Üë Importer</button>
                </div>
            </div>
            <div class="proj-grid" id="proj-grid"></div>
        </div>
    </div>

    <!-- DIALOGUE PANEL -->
    <div id="dlg-panel">
        <div id="dlg-hdr">
            <h3>DIALOGUE FOCALIS√â</h3>
            <button class="btn btn-ghost btn-sm" onclick="toggleDialogue()">‚úï</button>
        </div>
        <div class="mode-tabs">
            <button class="mode-tab on" data-dlgmode="conversational" onclick="switchDlgMode('conversational')">üí¨ Conversationnel</button>
            <button class="mode-tab" data-dlgmode="explorer" onclick="switchDlgMode('explorer')">üåÄ Explorer</button>
            <button class="mode-tab" data-dlgmode="psychoanalytic" onclick="switchDlgMode('psychoanalytic')">üß† Psychanalytique</button>
            <button class="mode-tab" data-dlgmode="strategic" onclick="switchDlgMode('strategic')">üéØ Strat√©gique</button>
        </div>
        <div id="dlg-msgs"></div>
        <div id="dlg-input">
            <textarea id="dlg-textarea" placeholder="Votre message..."></textarea>
            <button class="btn btn-ink btn-sm" onclick="sendDlgMessage()">Envoyer</button>
        </div>
    </div>
</div>

<!-- MODALS -->
<div id="new-cloud-modal" class="modal">
    <div class="modal-inner">
        <h3>Nouveau nuage</h3>
        <div class="form-group">
            <label>Texte</label>
            <textarea id="new-cloud-text" style="width:100%;min-height:120px;font-family:'Crimson Pro',serif;font-size:.88rem;padding:9px;border:1px solid var(--border);border-radius:3px;resize:vertical"></textarea>
        </div>
        <div class="form-group">
            <label>Image (optionnel)</label>
            <input type="file" id="new-cloud-image" accept="image/*">
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="closeModal('new-cloud-modal')">Annuler</button>
            <button class="btn btn-ink" onclick="createCloud()">Cr√©er</button>
        </div>
    </div>
</div>

<div id="new-project-modal" class="modal">
    <div class="modal-inner">
        <h3>Nouveau projet</h3>
        <div class="form-group">
            <label>Nom du projet</label>
            <input type="text" id="new-project-name" placeholder="Ex: Mon sc√©nario">
        </div>
        <div class="form-group">
            <label>Type de projet</label>
            <div class="radio-group">
                <label><input type="radio" name="projectType" value="s√©rie" checked> S√©rie de fiction</label>
                <label><input type="radio" name="projectType" value="film"> Long-m√©trage</label>
                <label><input type="radio" name="projectType" value="podcast"> Podcast narratif</label>
                <label><input type="radio" name="projectType" value="documentaire"> Documentaire</label>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="closeModal('new-project-modal')">Annuler</button>
            <button class="btn btn-ink" onclick="createProject()">Cr√©er</button>
        </div>
    </div>
</div>

<div id="rename-project-modal" class="modal">
    <div class="modal-inner">
        <h3>Renommer le projet</h3>
        <div class="form-group">
            <label>Nouveau nom</label>
            <input type="text" id="rename-project-input">
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="closeModal('rename-project-modal')">Annuler</button>
            <button class="btn btn-ink" onclick="renameProject()">Renommer</button>
        </div>
    </div>
</div>

<div id="notif"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let PROJECTS = {};
let ACTIVE_PID = null;
let currentFilter = 'all';
let currentSearchTerm = '';
let dialogueOpen = false;
let currentDlgMode = 'conversational';
let currentComboMode = 'developper';
let selectedCloudIds = new Set();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
    load();
    if (ACTIVE_PID) {
        renderAll();
    } else {
        switchTab('projets');
    }
});

function P() {
    if (!ACTIVE_PID || !PROJECTS[ACTIVE_PID]) return null;
    return PROJECTS[ACTIVE_PID];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function save() {
    localStorage.setItem('srd_projects', JSON.stringify(PROJECTS));
    localStorage.setItem('srd_active', ACTIVE_PID || '');
}

function load() {
    const raw = localStorage.getItem('srd_projects');
    if (raw) {
        PROJECTS = JSON.parse(raw);
    }
    ACTIVE_PID = localStorage.getItem('srd_active') || null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
    document.querySelectorAll('.sec').forEach(s => s.classList.remove('on'));
    
    document.querySelector(`.tab[data-sec="${tab}"]`).classList.add('on');
    document.getElementById(`sec-${tab}`).classList.add('on');
    
    if (tab === 'nuages') renderClouds();
    if (tab === 'tests') renderTests();
    if (tab === 'teaser') renderTeaser();
    if (tab === 'projets') renderProjects();
}

function goToProjects() {
    switchTab('projets');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showNewProjectModal() {
    document.getElementById('new-project-modal').classList.add('on');
}

function createProject() {
    const name = document.getElementById('new-project-name').value.trim();
    const type = document.querySelector('input[name="projectType"]:checked').value;
    
    if (!name) {
        notif('Veuillez entrer un nom');
        return;
    }
    
    const pid = Date.now().toString();
    PROJECTS[pid] = {
        id: pid,
        name: name,
        type: type,
        clouds: [],
        combinations: [],
        dialogue: []
    };
    
    ACTIVE_PID = pid;
    save();
    closeModal('new-project-modal');
    document.getElementById('new-project-name').value = '';
    renderAll();
    switchTab('nuages');
    notif('Projet cr√©√© !');
}

function openProject(pid) {
    ACTIVE_PID = pid;
    save();
    renderAll();
    switchTab('nuages');
}

function showRenameModal() {
    const p = P();
    if (!p) return;
    
    document.getElementById('rename-project-input').value = p.name;
    document.getElementById('rename-project-modal').classList.add('on');
}

function renameProject() {
    const p = P();
    if (!p) return;
    
    const newName = document.getElementById('rename-project-input').value.trim();
    if (!newName) return;
    
    p.name = newName;
    save();
    closeModal('rename-project-modal');
    updateHeader();
    notif('Projet renomm√©');
}

function deleteProject(pid) {
    if (!confirm('Supprimer ce projet ?')) return;
    
    delete PROJECTS[pid];
    if (ACTIVE_PID === pid) {
        ACTIVE_PID = null;
    }
    save();
    renderProjects();
    notif('Projet supprim√©');
}

function renderProjects() {
    const grid = document.getElementById('proj-grid');
    const pids = Object.keys(PROJECTS);
    
    if (pids.length === 0) {
        grid.innerHTML = '<div class="empty">Aucun projet. Cr√©ez-en un pour commencer.</div>';
        return;
    }
    
    grid.innerHTML = pids.map(pid => {
        const p = PROJECTS[pid];
        const isActive = pid === ACTIVE_PID;
        return `
            <div class="proj-card ${isActive ? 'active' : ''}">
                <div class="proj-name">${esc(p.name)}</div>
                ${isActive ? '<div style="color:var(--green);font-size:.7rem;margin-bottom:8px">‚óè Actif</div>' : ''}
                <div class="proj-meta">${p.type} ¬∑ ${p.clouds.length} nuages ¬∑ ${p.combinations.length} combinaisons</div>
                <div class="proj-actions">
                    <button class="btn btn-ink btn-sm" onclick="openProject('${pid}')">Ouvrir</button>
                    <button class="btn btn-sm" onclick="exportProject('${pid}')">‚Üì Exporter</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteProject('${pid}')">‚úï</button>
                </div>
            </div>
        `;
    }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOUDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showNewCloudModal() {
    document.getElementById('new-cloud-modal').classList.add('on');
}

function createCloud() {
    const p = P();
    if (!p) return;
    
    const text = document.getElementById('new-cloud-text').value.trim();
    if (!text) {
        notif('Le nuage doit contenir du texte');
        return;
    }
    
    const fileInput = document.getElementById('new-cloud-image');
    const file = fileInput.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const cloud = {
                id: Date.now().toString(),
                text: text,
                image: e.target.result,
                selected: false,
                important: false,
                explored: false
            };
            p.clouds.push(cloud);
            save();
            closeModal('new-cloud-modal');
            document.getElementById('new-cloud-text').value = '';
            fileInput.value = '';
            renderClouds();
            notif('Nuage cr√©√©');
        };
        reader.readAsDataURL(file);
    } else {
        const cloud = {
            id: Date.now().toString(),
            text: text,
            image: null,
            selected: false,
            important: false,
            explored: false
        };
        p.clouds.push(cloud);
        save();
        closeModal('new-cloud-modal');
        document.getElementById('new-cloud-text').value = '';
        renderClouds();
        notif('Nuage cr√©√©');
    }
}

function toggleCloudSelection(cid) {
    const p = P();
    if (!p) return;
    
    const cloud = p.clouds.find(c => c.id === cid);
    if (!cloud) return;
    
    cloud.selected = !cloud.selected;
    
    if (cloud.selected) {
        selectedCloudIds.add(cid);
    } else {
        selectedCloudIds.delete(cid);
    }
    
    save();
    renderClouds();
    renderTests();
}

function deleteCloud(cid) {
    const p = P();
    if (!p) return;
    
    if (!confirm('Supprimer ce nuage ?')) return;
    
    p.clouds = p.clouds.filter(c => c.id !== cid);
    selectedCloudIds.delete(cid);
    save();
    renderClouds();
    notif('Nuage supprim√©');
}

function filterClouds(filter) {
    currentFilter = filter;
    document.querySelectorAll('.fbtn[data-filter]').forEach(btn => btn.classList.remove('on'));
    document.querySelector(`.fbtn[data-filter="${filter}"]`).classList.add('on');
    renderClouds();
}

function searchClouds() {
    currentSearchTerm = document.getElementById('srch').value.toLowerCase();
    renderClouds();
}

function renderClouds() {
    const p = P();
    if (!p) return;
    
    let filtered = p.clouds;
    
    // Filter
    if (currentFilter === 'important') {
        filtered = filtered.filter(c => c.important);
    } else if (currentFilter === 'explored') {
        filtered = filtered.filter(c => c.explored);
    } else if (currentFilter === 'unused') {
        filtered = filtered.filter(c => !p.combinations.some(combo => combo.cloudIds.includes(c.id)));
    } else if (currentFilter === 'images') {
        filtered = filtered.filter(c => c.image);
    }
    
    // Search
    if (currentSearchTerm) {
        filtered = filtered.filter(c => c.text.toLowerCase().includes(currentSearchTerm));
    }
    
    const grid = document.getElementById('cgrid');
    
    if (filtered.length === 0) {
        grid.innerHTML = '<div class="empty">Aucun nuage trouv√©</div>';
        return;
    }
    
    grid.innerHTML = filtered.map(c => `
        <div class="ccard ${c.selected ? 'sel' : ''}" onclick="toggleCloudSelection('${c.id}')">
            <div class="chk">${c.selected ? '‚úì' : ''}</div>
            ${c.image ? `<div class="cimg-w"><img src="${c.image}"></div>` : ''}
            <div class="ctxt">${esc(c.text)}</div>
            <div class="cacts" onclick="event.stopPropagation()">
                <button class="icbtn del" onclick="deleteCloud('${c.id}')" title="Supprimer">‚úï</button>
            </div>
        </div>
    `).join('');
    
    updateHeader();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TESTS / COMBINATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTests() {
    const p = P();
    if (!p) return;
    
    // Active chips
    const selected = p.clouds.filter(c => c.selected);
    const chipsDiv = document.getElementById('active-chips');
    
    if (selected.length === 0) {
        chipsDiv.innerHTML = '<div style="color:var(--muted);font-size:.8rem;font-style:italic">S√©lectionnez des nuages...</div>';
    } else {
        chipsDiv.innerHTML = selected.map(c => `
            <div class="chip">
                ${c.text.substring(0, 30)}...
                <span class="chip-x" onclick="toggleCloudSelection('${c.id}')">√ó</span>
            </div>
        `).join('');
    }
    
    // Saved combos
    const savedDiv = document.getElementById('saved-combos');
    if (p.combinations.length === 0) {
        savedDiv.innerHTML = '<div style="color:var(--muted);font-size:.82rem;font-style:italic;text-align:center;padding:20px">Aucune combinaison sauvegard√©e</div>';
    } else {
        savedDiv.innerHTML = p.combinations.map(combo => `
            <div class="saved-combo-item" onclick="loadCombination('${combo.id}')">
                <div class="saved-combo-name">${esc(combo.name)}</div>
                <div class="saved-combo-info">${combo.cloudIds.length} nuages</div>
            </div>
        `).join('');
    }
    
    // Cloud list
    const listDiv = document.getElementById('test-cloud-list');
    listDiv.innerHTML = p.clouds.map(c => `
        <div class="cloud-item ${c.selected ? 'sel' : ''}" onclick="toggleCloudSelection('${c.id}')">
            <input type="checkbox" ${c.selected ? 'checked' : ''} onclick="event.stopPropagation();toggleCloudSelection('${c.id}')">
            ${c.text.substring(0, 60)}${c.text.length > 60 ? '...' : ''}
        </div>
    `).join('');
}

function switchComboMode(mode) {
    currentComboMode = mode;
    document.querySelectorAll('.mode-bar .fbtn').forEach(btn => btn.classList.remove('on'));
    document.querySelector(`.mode-bar .fbtn[data-mode="${mode}"]`).classList.add('on');
}

async function generateComboAnalysis() {
    const p = P();
    if (!p) return;
    
    const selected = p.clouds.filter(c => c.selected);
    if (selected.length === 0) {
        notif('S√©lectionnez des nuages');
        return;
    }
    
    const resultDiv = document.getElementById('combo-result');
    resultDiv.innerHTML = 'G√©n√©ration en cours...';
    
    const cloudsContext = selected.map(c => c.text).join('\n\n');
    
    let prompt = '';
    if (currentComboMode === 'developper') {
        prompt = `Tu es un d√©veloppeur narratif pour la fiction audiovisuelle fran√ßaise et europ√©enne.

Projet : ${p.name} (${p.type})

Nuages d'intuition :
${cloudsContext}

CONSIGNE : D√©veloppe une analyse narrative en explorant comment ces √©l√©ments peuvent se combiner. 150-200 mots max.`;
    } else if (currentComboMode === 'explorer') {
        prompt = `Tu es en mode EXPLORATION RHIZOMATIQUE.

Projet : ${p.name} (${p.type})

Nuages d'intuition :
${cloudsContext}

CONSIGNE : Ouvre le champ des possibles. Propose des tangentes inattendues, des connections surprenantes, des ramifications narratives. Imagine des angles non √©vidents. 150-200 mots max.`;
    } else if (currentComboMode === 'resister') {
        prompt = `Tu es un critique exigeant pour la fiction audiovisuelle.

Projet : ${p.name} (${p.type})

Nuages d'intuition :
${cloudsContext}

CONSIGNE : Interroge ce qui r√©siste, les tensions, les contradictions. Sois critique mais constructif. 150-200 mots max.`;
    }
    
    const response = await callClaude(prompt);
    resultDiv.textContent = response;
}

function saveCombination() {
    const p = P();
    if (!p) return;
    
    const selected = p.clouds.filter(c => c.selected);
    if (selected.length === 0) {
        notif('S√©lectionnez des nuages');
        return;
    }
    
    const name = document.getElementById('combo-name').value.trim() || `Combinaison ${p.combinations.length + 1}`;
    const analysis = document.getElementById('combo-result').textContent;
    
    const combo = {
        id: Date.now().toString(),
        name: name,
        cloudIds: selected.map(c => c.id),
        analysis: analysis,
        mode: currentComboMode
    };
    
    p.combinations.push(combo);
    save();
    renderTests();
    document.getElementById('combo-name').value = '';
    document.getElementById('combo-result').textContent = 'S√©lectionnez des nuages pour commencer...';
    notif('Combinaison sauvegard√©e');
}

function loadCombination(comboId) {
    const p = P();
    if (!p) return;
    
    const combo = p.combinations.find(c => c.id === comboId);
    if (!combo) return;
    
    // Deselect all
    p.clouds.forEach(c => c.selected = false);
    selectedCloudIds.clear();
    
    // Select combo clouds
    combo.cloudIds.forEach(cid => {
        const cloud = p.clouds.find(c => c.id === cid);
        if (cloud) {
            cloud.selected = true;
            selectedCloudIds.add(cid);
        }
    });
    
    document.getElementById('combo-result').textContent = combo.analysis || '';
    document.getElementById('combo-name').value = combo.name;
    
    save();
    renderTests();
    renderClouds();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEASER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTeaser() {
    const p = P();
    if (!p) return;
    
    // Populate combo select
    const select = document.getElementById('teaser-combo-select');
    select.innerHTML = '<option value="">S√©lectionner une combinaison...</option>' +
        p.combinations.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('');
}

async function generateTeaser() {
    const p = P();
    if (!p) return;
    
    const textarea = document.getElementById('teaser-text');
    textarea.value = 'G√©n√©ration en cours...';
    
    const comboId = document.getElementById('teaser-combo-select').value;
    let context = '';
    
    if (comboId) {
        const combo = p.combinations.find(c => c.id === comboId);
        if (combo) {
            const clouds = combo.cloudIds.map(cid => p.clouds.find(c => c.id === cid)).filter(Boolean);
            context = clouds.map(c => c.text).join('\n\n');
            if (combo.analysis) {
                context += '\n\nAnalyse :\n' + combo.analysis;
            }
        }
    } else {
        context = p.clouds.map(c => c.text).join('\n\n');
    }
    
    const prompt = `Tu es un auteur-d√©veloppeur narratif pour la fiction audiovisuelle fran√ßaise et europ√©enne.

Projet : ${p.name} (${p.type})

${context}

CONSIGNE : Propose un teaser ‚Äî 150-200 mots max ‚Äî qui ouvre l'histoire sans tout d√©voiler. Ton sobre, litt√©raire, sans clich√©s de pitch. √âcris directement le teaser, sans introduction.`;
    
    const response = await callClaude(prompt);
    textarea.value = response;
}

function clearTeaser() {
    document.getElementById('teaser-text').value = '';
}

function validateTeaser() {
    const text = document.getElementById('teaser-text').value.trim();
    if (!text) {
        notif('√âcrivez d\'abord un teaser');
        return;
    }
    notif('‚úì Teaser valid√© ‚Äî Phase 2');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DIALOGUE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleDialogue() {
    dialogueOpen = !dialogueOpen;
    document.getElementById('dlg-panel').classList.toggle('on', dialogueOpen);
    
    // Adjust main width
    const main = document.getElementById('main');
    if (dialogueOpen) {
        main.style.marginRight = '420px';
    } else {
        main.style.marginRight = '0';
    }
}

function switchDlgMode(mode) {
    currentDlgMode = mode;
    document.querySelectorAll('.mode-tab').forEach(btn => btn.classList.remove('on'));
    document.querySelector(`.mode-tab[data-dlgmode="${mode}"]`).classList.add('on');
}

async function sendDlgMessage() {
    const p = P();
    if (!p) return;
    
    const textarea = document.getElementById('dlg-textarea');
    const message = textarea.value.trim();
    if (!message) return;
    
    textarea.value = '';
    
    // Add user message
    if (!p.dialogue) p.dialogue = [];
    p.dialogue.push({ role: 'user', content: message, mode: currentDlgMode });
    
    renderDlgMessages();
    
    // Get selected clouds context
    const selected = p.clouds.filter(c => c.selected);
    const cloudsContext = selected.map(c => c.text).join('\n\n');
    
    let systemPrompt = '';
    
    if (currentDlgMode === 'conversational') {
        systemPrompt = `Tu es un collaborateur cr√©atif pour le d√©veloppement narratif. R√©ponds de mani√®re conversationnelle et naturelle.

Projet : ${p.name} (${p.type})

Nuages s√©lectionn√©s :
${cloudsContext || '(aucun)'}`;
    } else if (currentDlgMode === 'explorer') {
        systemPrompt = `Tu es en mode EXPLORATION RHIZOMATIQUE.

Projet : ${p.name} (${p.type})

Nuages s√©lectionn√©s :
${cloudsContext || '(aucun)'}

CONSIGNE : Ne cherche pas √† analyser le "pourquoi". Ouvre le champ des possibles. Propose des tangentes inattendues, des connections surprenantes, des ramifications narratives.`;
    } else if (currentDlgMode === 'psychoanalytic') {
        systemPrompt = `Tu es en mode PSYCHANALYTIQUE.

Projet : ${p.name}

Nuages s√©lectionn√©s :
${cloudsContext || '(aucun)'}

CONSIGNE : Interroge les d√©sirs latents, les contradictions, les non-dits. Creuse les tensions sous-jacentes.`;
    } else if (currentDlgMode === 'strategic') {
        let formatContext = '';
        if (p.type === 's√©rie') {
            formatContext = 'Pense structure s√©rielle, arcs de saison, bible de personnages.';
        } else if (p.type === 'film') {
            formatContext = 'Pense structure trois actes, condensation narrative.';
        } else if (p.type === 'podcast') {
            formatContext = 'Pense format audio, √©pisodes, narration sonore.';
        } else if (p.type === 'documentaire') {
            formatContext = 'Pense enqu√™te, angle √©ditorial, dispositif filmique.';
        }
        
        systemPrompt = `Tu es en mode STRAT√âGIQUE pour un projet de ${p.type}.
${formatContext}

Projet : ${p.name}

Nuages s√©lectionn√©s :
${cloudsContext || '(aucun)'}

CONSIGNE : R√©ponds de mani√®re strat√©gique et professionnelle en tenant compte des contraintes du format.`;
    }
    
    const fullPrompt = systemPrompt + '\n\nMessage : ' + message;
    const response = await callClaude(fullPrompt);
    
    p.dialogue.push({ role: 'assistant', content: response, mode: currentDlgMode });
    save();
    renderDlgMessages();
}

function renderDlgMessages() {
    const p = P();
    if (!p || !p.dialogue) return;
    
    const container = document.getElementById('dlg-msgs');
    container.innerHTML = p.dialogue.map(msg => `
        <div class="msg ${msg.role === 'user' ? 'mu' : 'mc'}">
            <div class="mlbl">${msg.role === 'user' ? 'Vous' : 'Claude'}</div>
            <div class="mb">${esc(msg.content)}</div>
        </div>
    `).join('');
    
    container.scrollTop = container.scrollHeight;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLAUDE API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function callClaude(prompt) {
    try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                model: "claude-sonnet-4-20250514",
                max_tokens: 1000,
                messages: [{ role: "user", content: prompt }]
            })
        });
        
        const data = await response.json();
        return data.content.find(c => c.type === "text")?.text || "Erreur de r√©ponse";
    } catch (error) {
        console.error("Erreur API:", error);
        return "Erreur de connexion √† l'API";
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHeader() {
    const p = P();
    if (!p) {
        document.getElementById('proj-lbl').textContent = '‚Äî';
        document.getElementById('ctr').textContent = '0 nuages';
        return;
    }
    
    document.getElementById('proj-lbl').innerHTML = `${esc(p.name)} <span class="proj-type-badge">${p.type}</span>`;
    document.getElementById('ctr').textContent = `${p.clouds.length} nuages`;
}

function renderAll() {
    updateHeader();
    renderClouds();
    renderTests();
    renderTeaser();
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('on');
}

function notif(msg) {
    const n = document.getElementById('notif');
    n.textContent = msg;
    n.classList.add('on');
    setTimeout(() => n.classList.remove('on'), 2500);
}

function esc(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function showSettings() {
    notif('Param√®tres (√† impl√©menter)');
}

function exportProject(pid) {
    const p = PROJECTS[pid];
    if (!p) return;
    
    const json = JSON.stringify(p, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${p.name}.json`;
    a.click();
    URL.revokeObjectURL(url);
    notif('Projet export√©');
}
</script>

</body>
</html>
