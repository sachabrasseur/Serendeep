<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serendeep - Outil de d√©veloppement narratif</title>
    <style>
/* SERENDEEP V3 - Styles complets */

:root {
    --primary: #2c3e50;
    --secondary: #3498db;
    --accent: #e74c3c;
    --success: #27ae60;
    --bg: #ecf0f1;
    --card-bg: #ffffff;
    --text: #2c3e50;
    --border: #bdc3c7;
    --hover-bg: #d5dbdb;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
}

/* Welcome Screen */
.welcome-screen {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.welcome-screen h1 {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--primary);
}

.welcome-screen h1 span {
    color: var(--accent);
    font-style: italic;
}

.welcome-screen p {
    margin-bottom: 2rem;
    color: #7f8c8d;
    font-size: 1.1rem;
}

/* Buttons */
.primary-btn {
    background: var(--secondary);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.3s;
}

.primary-btn:hover {
    background: #2980b9;
}

.secondary-btn {
    background: transparent;
    border: 1px solid var(--border);
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.3s;
}

.secondary-btn:hover {
    background: var(--bg);
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-content h2 {
    margin-bottom: 1.5rem;
    color: var(--primary);
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.form-group input[type="text"] {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 1rem;
}

.radio-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.radio-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: normal;
    cursor: pointer;
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
}

.modal-actions button {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
}

.modal-actions button:first-child {
    background: var(--border);
}

.modal-actions button:last-child {
    background: var(--secondary);
    color: white;
}

/* Workspace */
.workspace {
    min-height: 100vh;
    padding: 2rem;
}

.workspace-header {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.project-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
}

.project-display {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.project-name {
    font-size: 1.5rem;
    font-weight: 600;
    cursor: pointer;
}

.project-name:hover {
    color: var(--secondary);
}

.project-type {
    background: var(--secondary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
}

.rename-btn {
    background: transparent;
    border: 1px solid var(--border);
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.3s;
}

.rename-btn:hover {
    background: var(--bg);
}

/* Navigation Tabs */
.nav-tabs {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid var(--border);
}

.nav-tab {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
}

.nav-tab:hover {
    background: var(--bg);
}

.nav-tab.active {
    border-bottom-color: var(--secondary);
    color: var(--secondary);
    font-weight: 600;
}

/* Phase/Section */
.phase {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.phase h2 {
    margin-bottom: 1.5rem;
    color: var(--primary);
}

/* Cloud Input Zone */
.cloud-input-zone {
    margin-bottom: 2rem;
}

.cloud-input-zone textarea {
    width: 100%;
    min-height: 100px;
    padding: 1rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 1rem;
    font-family: inherit;
    resize: vertical;
}

.cloud-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.upload-btn {
    background: var(--bg);
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    border: 1px solid var(--border);
    transition: background 0.3s;
}

.upload-btn:hover {
    background: var(--hover-bg);
}

/* Clouds Container */
.filter-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.filter-tab {
    padding: 0.5rem 1rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.3s;
}

.filter-tab:hover {
    background: var(--hover-bg);
}

.filter-tab.active {
    background: var(--secondary);
    color: white;
    border-color: var(--secondary);
}

.clouds-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

/* Cloud Card */
.cloud {
    background: var(--bg);
    padding: 1rem;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
    position: relative;
}

.cloud:hover {
    border-color: var(--secondary);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.cloud.selected {
    border-color: var(--accent);
    background: #ffe6e6;
}

.cloud.important::before {
    content: "‚òÜ";
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    font-size: 1.2rem;
    color: #f39c12;
}

.cloud.explored::after {
    content: "‚úì";
    position: absolute;
    top: 0.5rem;
    right: 2.5rem;
    font-size: 1.2rem;
    color: var(--success);
}

.cloud-content {
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
    line-height: 1.5;
    font-style: italic;
    color: #34495e;
}

.cloud img {
    width: 100%;
    height: auto;
    border-radius: 4px;
    margin-bottom: 0.5rem;
}

.cloud-actions-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
}

.cloud-action-btn {
    flex: 1;
    padding: 0.5rem;
    background: white;
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
}

.cloud-action-btn:hover {
    background: var(--bg);
    transform: translateY(-2px);
}

.cloud-action-btn.important-btn:hover {
    background: #fff3cd;
    border-color: #f39c12;
}

.cloud-action-btn.explored-btn:hover {
    background: #d4edda;
    border-color: var(--success);
}

.cloud-action-btn.dialogue-btn:hover {
    background: #d1ecf1;
    border-color: #17a2b8;
}

/* Dialogue Zone */
.dialogue-zone {
    margin-top: 2rem;
}

.mode-selector {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.mode-btn {
    padding: 0.5rem 1rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.3s;
}

.mode-btn:hover {
    background: var(--hover-bg);
}

.mode-btn.active {
    background: var(--secondary);
    color: white;
    border-color: var(--secondary);
}

.dialogue-input {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.dialogue-input input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 1rem;
}

.dialogue-input button {
    padding: 0.75rem 1.5rem;
    background: var(--secondary);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
}

.dialogue-input button:hover {
    background: #2980b9;
}

.dialogue-messages {
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 1rem;
}

.message {
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 8px;
}

.message.user {
    background: #e8f4f8;
    margin-left: 2rem;
}

.message.assistant {
    background: var(--bg);
    margin-right: 2rem;
}

.message strong {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--primary);
}

/* Tests Section */
.test-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.combinations-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.combination-card {
    background: var(--bg);
    padding: 1.5rem;
    border-radius: 8px;
    border: 2px solid transparent;
    transition: all 0.3s;
}

.combination-card:hover {
    border-color: var(--secondary);
}

.combination-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.combination-title {
    font-weight: 600;
    font-size: 1.1rem;
}

.combination-clouds {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.combination-cloud-tag {
    background: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    border: 1px solid var(--border);
}

.combination-result {
    padding: 1rem;
    background: white;
    border-radius: 4px;
    margin-bottom: 0.75rem;
    font-style: italic;
}

/* Teaser Section */
.teaser-display {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    min-height: 300px;
    white-space: pre-wrap;
    line-height: 1.8;
}

.teaser-actions {
    display: flex;
    gap: 1rem;
}

/* Projects Section */
.projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.project-card {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.3s;
}

.project-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.project-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.project-card h3 {
    color: var(--primary);
    margin-bottom: 0.5rem;
}

.project-card-type {
    background: var(--secondary);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
}

.project-card-meta {
    font-size: 0.875rem;
    color: #7f8c8d;
    margin-bottom: 0.5rem;
}

.project-card-clouds {
    font-size: 0.875rem;
    color: var(--text);
}

/* Hidden */
.hidden {
    display: none !important;
}

/* Loading */
.loading {
    text-align: center;
    padding: 2rem;
    color: #7f8c8d;
}

/* Responsive */
@media (max-width: 768px) {
    .clouds-container {
        grid-template-columns: 1fr;
    }
    
    .projects-grid {
        grid-template-columns: 1fr;
    }
    
    .welcome-screen h1 {
        font-size: 2rem;
    }
}
    </style>
</head>
<body>

<!-- Welcome Screen -->
<div id="welcomeScreen" class="welcome-screen">
    <h1>Seren<span>deep</span></h1>
    <p>Outil de d√©veloppement narratif</p>
    <button class="primary-btn" onclick="showNewProjectModal()">+ Nouveau projet</button>
</div>

<!-- Project Creation Modal -->
<div id="newProjectModal" class="modal hidden">
    <div class="modal-content">
        <h2>Nouveau projet</h2>
        <div class="form-group">
            <label for="projectName">Nom du projet</label>
            <input type="text" id="projectName" placeholder="Ex: Le rendez-vous secret">
        </div>
        <div class="form-group">
            <label>Type de projet</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="projectType" value="s√©rie" checked>
                    S√©rie
                </label>
                <label>
                    <input type="radio" name="projectType" value="film">
                    Film
                </label>
                <label>
                    <input type="radio" name="projectType" value="podcast">
                    Podcast
                </label>
                <label>
                    <input type="radio" name="projectType" value="documentaire">
                    Documentaire
                </label>
            </div>
        </div>
        <div class="modal-actions">
            <button onclick="closeNewProjectModal()">Annuler</button>
            <button onclick="createProject()">Cr√©er</button>
        </div>
    </div>
</div>

<!-- Rename Project Modal -->
<div id="renameProjectModal" class="modal hidden">
    <div class="modal-content">
        <h2>Renommer le projet</h2>
        <div class="form-group">
            <label for="newProjectName">Nouveau nom</label>
            <input type="text" id="newProjectName">
        </div>
        <div class="modal-actions">
            <button onclick="closeRenameModal()">Annuler</button>
            <button onclick="confirmRename()">Renommer</button>
        </div>
    </div>
</div>

<!-- Workspace -->
<div id="workspace" class="workspace hidden">
    <div class="workspace-header">
        <div class="project-header">
            <div class="project-display">
                <h1 class="project-name" id="currentProjectName" onclick="showRenameModal()">Mon Projet</h1>
                <span class="project-type" id="currentProjectType">s√©rie</span>
            </div>
            <button class="rename-btn" onclick="showRenameModal()">‚úèÔ∏è Renommer</button>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('nuages')">NUAGES</button>
            <button class="nav-tab" onclick="switchTab('tests')">TESTS</button>
            <button class="nav-tab" onclick="switchTab('teaser')">TEASER</button>
            <button class="nav-tab" onclick="switchTab('projets')">PROJETS</button>
        </div>
    </div>

    <!-- Tab: Nuages -->
    <div id="tab-nuages" class="tab-content">
        <div class="phase">
            <h2>Nuages</h2>
            
            <div class="cloud-input-zone">
                <textarea id="cloudInput" placeholder="D√©posez vos intuitions narratives ici..."></textarea>
                <div class="cloud-actions">
                    <button class="primary-btn" onclick="addCloud()">+ Nouveau nuage</button>
                    <label class="upload-btn">
                        üìé Ajouter une image
                        <input type="file" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    </label>
                </div>
            </div>

            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterClouds('all')">TOUS</button>
                <button class="filter-tab" onclick="filterClouds('important')">IMPORTANTS</button>
                <button class="filter-tab" onclick="filterClouds('explored')">EXPLOR√âS</button>
                <button class="filter-tab" onclick="filterClouds('unused')">NON UTILIS√âS</button>
                <button class="filter-tab" onclick="filterClouds('images')">AVEC IMAGES</button>
            </div>

            <div id="cloudsContainer" class="clouds-container">
                <!-- Les nuages seront ajout√©s ici dynamiquement -->
            </div>
        </div>

        <!-- Dialogue Zone -->
        <div class="phase dialogue-zone">
            <h2>Dialogue focalis√©</h2>
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="explorer" onclick="selectDialogueMode('explorer')">Explorer</button>
                <button class="mode-btn" data-mode="developer" onclick="selectDialogueMode('developer')">D√©velopper</button>
                <button class="mode-btn" data-mode="resister" onclick="selectDialogueMode('resister')">R√©sister</button>
                <button class="mode-btn" data-mode="psychanalytic" onclick="selectDialogueMode('psychanalytic')">Psychanalytique</button>
            </div>

            <div id="dialogueMessages" class="dialogue-messages"></div>

            <div class="dialogue-input">
                <input type="text" id="dialogueInput" placeholder="Posez votre question ou partagez une r√©flexion...">
                <button onclick="sendDialogueMessage()">‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Tab: Tests -->
    <div id="tab-tests" class="tab-content hidden">
        <div class="phase">
            <h2>Tests de combinaisons</h2>
            <div class="test-controls">
                <button class="primary-btn" onclick="generateCombination()">üé≤ G√©n√©rer une combinaison</button>
                <button class="secondary-btn" onclick="clearCombinations()">Effacer tout</button>
            </div>

            <div id="combinationsList" class="combinations-list">
                <!-- Les combinaisons seront ajout√©es ici -->
            </div>
        </div>
    </div>

    <!-- Tab: Teaser -->
    <div id="tab-teaser" class="tab-content hidden">
        <div class="phase">
            <h2>Teaser narratif</h2>
            <div id="teaserDisplay" class="teaser-display">
                S√©lectionnez une combinaison dans l'onglet Tests pour g√©n√©rer un teaser...
            </div>
            <div class="teaser-actions">
                <button class="primary-btn" onclick="generateTeaserFromCombination()">‚ú® G√©n√©rer teaser</button>
                <button class="secondary-btn" onclick="regenerateTeaser()">üîÑ R√©g√©n√©rer</button>
            </div>
        </div>
    </div>

    <!-- Tab: Projets -->
    <div id="tab-projets" class="tab-content hidden">
        <div class="phase">
            <h2>Mes projets</h2>
            <button class="primary-btn" onclick="showNewProjectModal()" style="margin-bottom: 1.5rem;">+ Nouveau projet</button>
            <div id="projectsGrid" class="projects-grid">
                <!-- Les projets seront list√©s ici -->
            </div>
        </div>
    </div>
</div>

<script>
// ===============================
// STATE MANAGEMENT
// ===============================

let currentProject = null;
let allProjects = [];
let currentDialogueMode = 'explorer';
let selectedClouds = [];
let currentFilter = 'all';
let currentCombination = null;

// Charger les projets depuis localStorage
function loadProjects() {
    const saved = localStorage.getItem('serendeep_projects');
    if (saved) {
        allProjects = JSON.parse(saved);
    }
}

// Sauvegarder les projets dans localStorage
function saveProjects() {
    localStorage.setItem('serendeep_projects', JSON.stringify(allProjects));
}

// ===============================
// PROJECT MANAGEMENT
// ===============================

function showNewProjectModal() {
    document.getElementById('newProjectModal').classList.remove('hidden');
}

function closeNewProjectModal() {
    document.getElementById('newProjectModal').classList.add('hidden');
    document.getElementById('projectName').value = '';
}

function createProject() {
    const name = document.getElementById('projectName').value.trim();
    const typeRadio = document.querySelector('input[name="projectType"]:checked');
    const type = typeRadio ? typeRadio.value : 's√©rie';
    
    if (!name) {
        alert('Veuillez entrer un nom de projet');
        return;
    }
    
    const project = {
        id: Date.now(),
        name: name,
        type: type,
        createdAt: new Date().toISOString(),
        clouds: [],
        combinations: [],
        teaser: '',
        dialogueHistory: []
    };
    
    allProjects.push(project);
    saveProjects();
    closeNewProjectModal();
    loadProject(project.id);
}

function loadProject(projectId) {
    currentProject = allProjects.find(p => p.id === projectId);
    if (!currentProject) return;
    
    // Masquer welcome screen
    document.getElementById('welcomeScreen').classList.add('hidden');
    
    // Afficher workspace
    document.getElementById('workspace').classList.remove('hidden');
    
    // Mettre √† jour l'interface
    document.getElementById('currentProjectName').textContent = currentProject.name;
    document.getElementById('currentProjectType').textContent = currentProject.type;
    
    // Charger les nuages
    renderClouds();
    
    // Charger les combinaisons
    renderCombinations();
    
    // Charger le teaser
    if (currentProject.teaser) {
        document.getElementById('teaserDisplay').textContent = currentProject.teaser;
    }
    
    // Charger les projets dans l'onglet projets
    renderProjectsList();
}

function showRenameModal() {
    if (!currentProject) return;
    document.getElementById('newProjectName').value = currentProject.name;
    document.getElementById('renameProjectModal').classList.remove('hidden');
}

function closeRenameModal() {
    document.getElementById('renameProjectModal').classList.add('hidden');
}

function confirmRename() {
    const newName = document.getElementById('newProjectName').value.trim();
    if (!newName) {
        alert('Veuillez entrer un nom');
        return;
    }
    
    currentProject.name = newName;
    document.getElementById('currentProjectName').textContent = newName;
    saveProjects();
    closeRenameModal();
}

// ===============================
// TABS NAVIGATION
// ===============================

function switchTab(tabName) {
    // Mettre √† jour les boutons
    document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Masquer tous les contenus
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Afficher le contenu demand√©
    document.getElementById('tab-' + tabName).classList.remove('hidden');
    
    // Charger les donn√©es sp√©cifiques
    if (tabName === 'projets') {
        renderProjectsList();
    }
}

// ===============================
// CLOUDS MANAGEMENT
// ===============================

function addCloud() {
    const content = document.getElementById('cloudInput').value.trim();
    if (!content) {
        alert('Veuillez entrer du contenu pour le nuage');
        return;
    }
    
    const cloud = {
        id: Date.now(),
        content: content,
        image: null,
        important: false,
        explored: false,
        createdAt: new Date().toISOString()
    };
    
    currentProject.clouds.push(cloud);
    document.getElementById('cloudInput').value = '';
    saveProjects();
    renderClouds();
}

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const content = document.getElementById('cloudInput').value.trim() || 'Image sans texte';
        const cloud = {
            id: Date.now(),
            content: content,
            image: e.target.result,
            important: false,
            explored: false,
            createdAt: new Date().toISOString()
        };
        
        currentProject.clouds.push(cloud);
        document.getElementById('cloudInput').value = '';
        saveProjects();
        renderClouds();
    };
    reader.readAsDataURL(file);
}

function toggleCloudSelection(cloudId) {
    const index = selectedClouds.indexOf(cloudId);
    if (index > -1) {
        selectedClouds.splice(index, 1);
    } else {
        selectedClouds.push(cloudId);
    }
    renderClouds();
}

function toggleCloudImportant(cloudId, event) {
    event.stopPropagation();
    const cloud = currentProject.clouds.find(c => c.id === cloudId);
    if (cloud) {
        cloud.important = !cloud.important;
        saveProjects();
        renderClouds();
    }
}

function toggleCloudExplored(cloudId, event) {
    event.stopPropagation();
    const cloud = currentProject.clouds.find(c => c.id === cloudId);
    if (cloud) {
        cloud.explored = !cloud.explored;
        saveProjects();
        renderClouds();
    }
}

function openCloudDialogue(cloudId, event) {
    event.stopPropagation();
    const cloud = currentProject.clouds.find(c => c.id === cloudId);
    if (!cloud) return;
    
    // S√©lectionner le nuage
    selectedClouds = [cloudId];
    renderClouds();
    
    // Scroller vers la zone de dialogue
    document.querySelector('.dialogue-zone').scrollIntoView({ behavior: 'smooth' });
    
    // Pr√©-remplir avec une question contextuelle
    document.getElementById('dialogueInput').value = `Aide-moi √† approfondir cette intuition : "${cloud.content.substring(0, 50)}..."`;
}

function filterClouds(filter) {
    currentFilter = filter;
    
    // Mettre √† jour les boutons
    document.querySelectorAll('.filter-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderClouds();
}

function renderClouds() {
    if (!currentProject) return;
    
    const container = document.getElementById('cloudsContainer');
    container.innerHTML = '';
    
    let cloudsToShow = currentProject.clouds;
    
    // Appliquer les filtres
    if (currentFilter === 'important') {
        cloudsToShow = cloudsToShow.filter(c => c.important);
    } else if (currentFilter === 'explored') {
        cloudsToShow = cloudsToShow.filter(c => c.explored);
    } else if (currentFilter === 'unused') {
        cloudsToShow = cloudsToShow.filter(c => !c.important && !c.explored);
    } else if (currentFilter === 'images') {
        cloudsToShow = cloudsToShow.filter(c => c.image);
    }
    
    cloudsToShow.forEach(cloud => {
        const cloudDiv = document.createElement('div');
        cloudDiv.className = 'cloud';
        if (selectedClouds.includes(cloud.id)) {
            cloudDiv.className += ' selected';
        }
        if (cloud.important) {
            cloudDiv.className += ' important';
        }
        if (cloud.explored) {
            cloudDiv.className += ' explored';
        }
        
        cloudDiv.onclick = () => toggleCloudSelection(cloud.id);
        
        let html = '';
        
        if (cloud.image) {
            html += `<img src="${cloud.image}" alt="Image du nuage">`;
        }
        
        html += `<div class="cloud-content">${cloud.content}</div>`;
        
        html += `
            <div class="cloud-actions-buttons">
                <button class="cloud-action-btn important-btn" onclick="toggleCloudImportant(${cloud.id}, event)" title="Important">
                    ‚òÜ Imp
                </button>
                <button class="cloud-action-btn explored-btn" onclick="toggleCloudExplored(${cloud.id}, event)" title="Explor√©">
                    ‚úì Exp
                </button>
                <button class="cloud-action-btn dialogue-btn" onclick="openCloudDialogue(${cloud.id}, event)" title="Dialogue">
                    üí¨ Dlg
                </button>
            </div>
        `;
        
        cloudDiv.innerHTML = html;
        container.appendChild(cloudDiv);
    });
    
    if (cloudsToShow.length === 0) {
        container.innerHTML = '<div class="loading">Aucun nuage ne correspond √† ce filtre</div>';
    }
}

// ===============================
// DIALOGUE SYSTEM
// ===============================

function selectDialogueMode(mode) {
    currentDialogueMode = mode;
    
    // Mettre √† jour les boutons
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

async function sendDialogueMessage() {
    const input = document.getElementById('dialogueInput');
    const message = input.value.trim();
    if (!message) return;
    
    // Ajouter le message de l'utilisateur
    addDialogueMessage('user', message);
    input.value = '';
    
    // Pr√©parer le contexte
    const selectedCloudContents = selectedClouds.map(id => {
        const cloud = currentProject.clouds.find(c => c.id === id);
        return cloud ? cloud.content : '';
    }).filter(Boolean);
    
    // G√©n√©rer la r√©ponse avec Claude
    await generateDialogueResponse(message, selectedCloudContents);
}

function addDialogueMessage(sender, text) {
    const messagesDiv = document.getElementById('dialogueMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    messageDiv.innerHTML = `
        <strong>${sender === 'user' ? 'Vous' : 'Claude'}</strong>
        <div>${text}</div>
    `;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    // Sauvegarder dans l'historique
    if (currentProject) {
        if (!currentProject.dialogueHistory) {
            currentProject.dialogueHistory = [];
        }
        currentProject.dialogueHistory.push({ sender, text, mode: currentDialogueMode, timestamp: new Date().toISOString() });
        saveProjects();
    }
}

async function generateDialogueResponse(userMessage, cloudContents) {
    // Construire le prompt en fonction du mode
    let systemPrompt = '';
    
    if (currentDialogueMode === 'explorer') {
        systemPrompt = `Tu es un assistant cr√©atif qui aide √† explorer et ouvrir les possibles narratifs. 
        Ta mission est d'encourager la divergence, de proposer des pistes inattendues, et d'√©largir le champ des possibles.
        Ne cherche pas √† structurer ou √† conclure - aide plut√¥t √† g√©n√©rer encore plus d'options et de variations.`;
    } else if (currentDialogueMode === 'developer') {
        systemPrompt = `Tu es un assistant qui aide √† d√©velopper et enrichir les intuitions narratives.
        Tu poses des questions pr√©cises pour construire et approfondir : personnages, univers, structure, th√®mes.
        Type de projet: ${currentProject.type}. Adapte tes suggestions en fonction de ce format.`;
    } else if (currentDialogueMode === 'resister') {
        systemPrompt = `Tu es un assistant critique constructif qui challenge les id√©es.
        Tu identifies les faiblesses, les clich√©s, les incoh√©rences potentielles.
        Tu pousses √† aller plus loin, √† √™tre plus original, plus radical dans les choix narratifs.`;
    } else if (currentDialogueMode === 'psychanalytic') {
        systemPrompt = `Tu es un assistant qui analyse les d√©sirs latents et les contradictions dans les intuitions narratives.
        Tu interroges ce qui se cache sous les choix narratifs : quels d√©sirs? quelles peurs? quelles tensions non r√©solues?
        Tu aides √† r√©v√©ler les motivations profondes du cr√©ateur √† travers ses choix.`;
    }
    
    let contextText = '';
    if (cloudContents.length > 0) {
        contextText = `\n\nNuages s√©lectionn√©s:\n${cloudContents.map((c, i) => `${i + 1}. ${c}`).join('\n')}`;
    }
    
    const prompt = `${systemPrompt}\n\nType de projet: ${currentProject.type}${contextText}\n\nMessage de l'utilisateur: ${userMessage}`;
    
    try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 1000,
                messages: [
                    { role: 'user', content: prompt }
                ]
            })
        });
        
        const data = await response.json();
        const assistantMessage = data.content[0].text;
        addDialogueMessage('assistant', assistantMessage);
    } catch (error) {
        addDialogueMessage('assistant', "D√©sol√©, je n'ai pas pu g√©n√©rer de r√©ponse. Erreur: " + error.message);
    }
}

// ===============================
// TESTS & COMBINATIONS
// ===============================

function generateCombination() {
    if (!currentProject || currentProject.clouds.length < 2) {
        alert('Il faut au moins 2 nuages pour g√©n√©rer une combinaison');
        return;
    }
    
    // S√©lectionner al√©atoirement 2-4 nuages
    const numClouds = Math.min(Math.floor(Math.random() * 3) + 2, currentProject.clouds.length);
    const shuffled = [...currentProject.clouds].sort(() => 0.5 - Math.random());
    const selectedForCombo = shuffled.slice(0, numClouds);
    
    const combination = {
        id: Date.now(),
        clouds: selectedForCombo.map(c => ({ id: c.id, content: c.content })),
        result: '',
        createdAt: new Date().toISOString()
    };
    
    if (!currentProject.combinations) {
        currentProject.combinations = [];
    }
    currentProject.combinations.push(combination);
    
    // G√©n√©rer le r√©sultat
    generateCombinationResult(combination);
}

async function generateCombinationResult(combination) {
    const cloudTexts = combination.clouds.map(c => c.content).join('\n\n');
    
    // Adapter le prompt en fonction du type de projet
    let prompt = `Type de projet: ${currentProject.type}\n\nVoici des intuitions narratives √† combiner:\n\n${cloudTexts}\n\n`;
    
    if (currentProject.type === 's√©rie') {
        prompt += `Propose une id√©e de s√©rie qui combine ces √©l√©ments de mani√®re originale et coh√©rente. D√©cris le concept en 2-3 paragraphes.`;
    } else if (currentProject.type === 'film') {
        prompt += `Propose un concept de film qui int√®gre ces √©l√©ments. D√©cris le pitch en 2-3 paragraphes.`;
    } else if (currentProject.type === 'podcast') {
        prompt += `Propose un concept de podcast qui utilise ces √©l√©ments narratifs. D√©cris le format et l'approche.`;
    } else if (currentProject.type === 'documentaire') {
        prompt += `Propose un angle documentaire qui explore ces th√®mes. D√©cris l'approche et la structure.`;
    }
    
    try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 1000,
                messages: [
                    { role: 'user', content: prompt }
                ]
            })
        });
        
        const data = await response.json();
        combination.result = data.content[0].text;
        saveProjects();
        renderCombinations();
    } catch (error) {
        combination.result = "Erreur lors de la g√©n√©ration: " + error.message;
        saveProjects();
        renderCombinations();
    }
}

function clearCombinations() {
    if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les combinaisons ?')) {
        currentProject.combinations = [];
        saveProjects();
        renderCombinations();
    }
}

function selectCombinationForTeaser(combinationId) {
    currentCombination = currentProject.combinations.find(c => c.id === combinationId);
    switchTab('teaser');
    
    // Mettre √† jour le bouton teaser dans la nav
    document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === 'TEASER') {
            btn.classList.add('active');
        }
    });
}

function renderCombinations() {
    if (!currentProject) return;
    
    const container = document.getElementById('combinationsList');
    container.innerHTML = '';
    
    if (!currentProject.combinations || currentProject.combinations.length === 0) {
        container.innerHTML = '<div class="loading">Aucune combinaison g√©n√©r√©e. Cliquez sur "G√©n√©rer une combinaison" pour commencer.</div>';
        return;
    }
    
    currentProject.combinations.forEach(combo => {
        const comboDiv = document.createElement('div');
        comboDiv.className = 'combination-card';
        
        const html = `
            <div class="combination-header">
                <div class="combination-title">Combinaison ${new Date(combo.createdAt).toLocaleDateString()}</div>
                <button class="secondary-btn" onclick="selectCombinationForTeaser(${combo.id})">‚Üí Cr√©er teaser</button>
            </div>
            <div class="combination-clouds">
                ${combo.clouds.map(c => `<span class="combination-cloud-tag">${c.content.substring(0, 40)}...</span>`).join('')}
            </div>
            ${combo.result ? `<div class="combination-result">${combo.result}</div>` : '<div class="loading">G√©n√©ration en cours...</div>'}
        `;
        
        comboDiv.innerHTML = html;
        container.appendChild(comboDiv);
    });
}

// ===============================
// TEASER GENERATION
// ===============================

async function generateTeaserFromCombination() {
    if (!currentCombination) {
        alert('Veuillez d\'abord s√©lectionner une combinaison dans l\'onglet Tests');
        return;
    }
    
    const teaserDisplay = document.getElementById('teaserDisplay');
    teaserDisplay.textContent = 'G√©n√©ration du teaser en cours...';
    
    const prompt = `Type de projet: ${currentProject.type}\n\n√Ä partir de cette combinaison:\n\n${currentCombination.result}\n\n√âcris un teaser narratif captivant qui donne envie de d√©couvrir ce projet. Le teaser doit √™tre √©vocateur, myst√©rieux, et planter l'univers sans tout r√©v√©ler. 3-4 paragraphes maximum.`;
    
    try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 1000,
                messages: [
                    { role: 'user', content: prompt }
                ]
            })
        });
        
        const data = await response.json();
        const teaser = data.content[0].text;
        currentProject.teaser = teaser;
        teaserDisplay.textContent = teaser;
        saveProjects();
    } catch (error) {
        teaserDisplay.textContent = "Erreur lors de la g√©n√©ration du teaser: " + error.message;
    }
}

async function regenerateTeaser() {
    await generateTeaserFromCombination();
}

// ===============================
// PROJECTS LIST
// ===============================

function renderProjectsList() {
    const container = document.getElementById('projectsGrid');
    container.innerHTML = '';
    
    if (allProjects.length === 0) {
        container.innerHTML = '<div class="loading">Aucun projet. Cliquez sur "+ Nouveau projet" pour commencer.</div>';
        return;
    }
    
    allProjects.forEach(project => {
        const card = document.createElement('div');
        card.className = 'project-card';
        card.onclick = () => loadProject(project.id);
        
        const date = new Date(project.createdAt).toLocaleDateString('fr-FR');
        const cloudsCount = project.clouds ? project.clouds.length : 0;
        
        card.innerHTML = `
            <div class="project-card-header">
                <h3>${project.name}</h3>
                <span class="project-card-type">${project.type}</span>
            </div>
            <div class="project-card-meta">Cr√©√© le ${date}</div>
            <div class="project-card-clouds">${cloudsCount} nuage${cloudsCount > 1 ? 's' : ''}</div>
        `;
        
        container.appendChild(card);
    });
}

// ===============================
// INITIALIZATION
// ===============================

function init() {
    loadProjects();
    
    // Si des projets existent, afficher la liste
    if (allProjects.length > 0) {
        // Optionnel: charger le dernier projet automatiquement
        // loadProject(allProjects[allProjects.length - 1].id);
    }
    
    // Support Enter dans les inputs
    document.getElementById('dialogueInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendDialogueMessage();
        }
    });
}

// D√©marrer l'application
init();
</script>

</body>
</html>